# Render Deployment Configuration

## Commands

### Build Command
```bash
pip install -r requirements.txt && python manage.py collectstatic --noinput && python manage.py migrate --noinput && python manage.py create_superuser_if_not_exists --noinput
```

**What it does:**
1. `pip install -r requirements.txt` - Installs all Python dependencies
2. `python manage.py collectstatic --noinput` - Collects static files for WhiteNoise
3. `python manage.py migrate --noinput` - Runs database migrations
4. `python manage.py create_superuser_if_not_exists --noinput` - Creates admin user automatically

### Start Command
```bash
gunicorn hostel_gatepass.wsgi:application --bind 0.0.0.0:$PORT
```

**What it does:**
- Starts the Gunicorn WSGI server
- Binds to `0.0.0.0:$PORT` (Render automatically provides the `$PORT` variable)

---

## Environment Variables

### Required Environment Variables

| Variable | Value | Description |
|----------|-------|-------------|
| `DEBUG` | `False` | Disables debug mode for production |
| `SECRET_KEY` | *(Auto-generated)* | Django secret key (auto-generated by Render) |
| `DATABASE_URL` | *(Auto-linked)* | PostgreSQL database connection string (auto-linked from database service) |
| `PYTHON_VERSION` | `3.11.7` | Python version to use |
| `ALLOWED_HOSTS` | `.onrender.com` | Allowed hostnames for the application |

### Superuser Configuration (Optional - Auto-created)

| Variable | Value | Description |
|----------|-------|-------------|
| `DJANGO_SUPERUSER_USERNAME` | `admin` | Admin username (default: admin) |
| `DJANGO_SUPERUSER_EMAIL` | `admin@hostel.com` | Admin email (default: admin@hostel.com) |
| `DJANGO_SUPERUSER_PASSWORD` | *(Auto-generated)* | Admin password (auto-generated by Render) |

### Additional Optional Environment Variables

These can be added if needed:

| Variable | Example Value | Description |
|----------|---------------|-------------|
| `EMAIL_BACKEND` | `django.core.mail.backends.smtp.EmailBackend` | Email backend (required for sending emails) |
| `EMAIL_HOST` | `smtp.gmail.com` | SMTP server hostname |
| `EMAIL_PORT` | `587` | SMTP server port (587 for TLS, 465 for SSL) |
| `EMAIL_USE_TLS` | `True` | Use TLS encryption (True for Gmail) |
| `EMAIL_HOST_USER` | `your-email@gmail.com` | Email address to send from |
| `EMAIL_HOST_PASSWORD` | `your-app-password` | Email password or app password |
| `DEFAULT_FROM_EMAIL` | `no-reply@hostel.com` | Default sender email address |
| `ALLOWED_HOSTS` | `yourdomain.com,www.yourdomain.com` | Additional allowed hosts (comma-separated) |

---

## Manual Setup in Render Dashboard

If you're setting up manually (not using render.yaml), use these settings:

### Service Configuration
- **Name:** `gatepass-django`
- **Environment:** `Python 3`
- **Region:** Choose closest to you
- **Branch:** `main`
- **Root Directory:** `Gatepass` ⚠️ **IMPORTANT!**
- **Build Command:** 
  ```bash
  pip install -r requirements.txt && python manage.py collectstatic --noinput && python manage.py migrate --noinput && python manage.py create_superuser_if_not_exists --noinput
  ```
- **Start Command:**
  ```bash
  gunicorn hostel_gatepass.wsgi:application --bind 0.0.0.0:$PORT
  ```

### Environment Variables (Manual Setup)

Add these in Render Dashboard → Environment:

```
DEBUG=False
PYTHON_VERSION=3.11.7
SECRET_KEY=<generate-using-command-below>
ALLOWED_HOSTS=.onrender.com
DATABASE_URL=<from-database-service-internal-url>
DJANGO_SUPERUSER_USERNAME=admin
DJANGO_SUPERUSER_EMAIL=admin@hostel.com
DJANGO_SUPERUSER_PASSWORD=<your-secure-password>
```

### Generate SECRET_KEY

Run this locally to generate a secure secret key:
```bash
python -c "from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())"
```

---

## Database Configuration

### Database Service (Automatically Created)

If using `render.yaml`, the database is automatically created:

- **Name:** `gatepass-db`
- **Type:** PostgreSQL
- **Plan:** Free
- **Database Name:** `gatepass`
- **User:** `gatepass_user`

The `DATABASE_URL` is automatically linked to the web service.

---

## Important Notes

1. **Root Directory:** Must be set to `Gatepass` - this is critical for the deployment to work!

2. **Superuser Creation:** The custom management command `create_superuser_if_not_exists` automatically creates the admin user during deployment if it doesn't exist.

3. **Static Files:** WhiteNoise handles static file serving, so `collectstatic` is required during build.

4. **Port Binding:** Always use `$PORT` environment variable (provided by Render) - never hardcode a port number.

5. **Security:** In production (when `DEBUG=False`), Django automatically enables:
   - HTTPS redirect
   - Secure cookies
   - HSTS headers

---

## Verification After Deployment

1. Check the deployment logs in Render dashboard
2. Visit your app URL (e.g., `https://gatepass-django.onrender.com`)
3. Login with admin credentials (check `DJANGO_SUPERUSER_PASSWORD` in Environment tab)
4. Verify database connection works
5. Check static files are loading correctly

---

## Email Configuration (Required for Registration Emails)

Registration emails are automatically sent when students, wardens, or security staff register. To enable email sending, configure SMTP settings.

### Option 1: Gmail SMTP (Recommended for Testing)

1. **Enable 2-Factor Authentication** on your Gmail account
2. **Create an App Password**:
   - Go to https://myaccount.google.com/apppasswords
   - Select "Mail" and "Other (Custom name)"
   - Enter "Gatepass System" and click "Generate"
   - Copy the 16-character password

3. **Add Environment Variables in Render**:
   ```
   EMAIL_BACKEND=django.core.mail.backends.smtp.EmailBackend
   EMAIL_HOST=smtp.gmail.com
   EMAIL_PORT=587
   EMAIL_USE_TLS=True
   EMAIL_HOST_USER=your-email@gmail.com
   EMAIL_HOST_PASSWORD=your-16-char-app-password
   DEFAULT_FROM_EMAIL=your-email@gmail.com
   ```

### Option 2: Other SMTP Providers

#### Outlook/Hotmail:
```
EMAIL_HOST=smtp-mail.outlook.com
EMAIL_PORT=587
EMAIL_USE_TLS=True
```

#### SendGrid (Free tier available):
```
EMAIL_HOST=smtp.sendgrid.net
EMAIL_PORT=587
EMAIL_USE_TLS=True
EMAIL_HOST_USER=apikey
EMAIL_HOST_PASSWORD=your-sendgrid-api-key
```

#### Mailgun:
```
EMAIL_HOST=smtp.mailgun.org
EMAIL_PORT=587
EMAIL_USE_TLS=True
```

### Important Notes:
- **Without email configuration**, registration emails will only appear in logs (console backend)
- **Gmail App Passwords** are required if 2FA is enabled (regular password won't work)
- **Test emails** after deployment to ensure they're being sent correctly
- Check **Render logs** if emails aren't arriving to debug issues

## Troubleshooting

### If emails aren't being sent:
1. Verify all email environment variables are set correctly
2. Check Render logs for email errors
3. For Gmail: Ensure App Password is used (not regular password)
4. Verify EMAIL_HOST_USER matches the account sending emails
5. Test SMTP credentials using a simple email client

### If deployment fails:
1. Check Root Directory is set to `Gatepass`
2. Verify all environment variables are set correctly
3. Check build logs for dependency issues
4. Ensure `requirements.txt` has all necessary packages
5. Verify database service is created and linked

### If you see "ModuleNotFoundError: No module named 'hostel_gatepass'":
- This means Root Directory is NOT set correctly
- Make sure Root Directory = `Gatepass` in Render dashboard

